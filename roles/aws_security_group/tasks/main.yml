---
- name: Create AWS security group for DevOps
  ec2_group:
    name: "{{ ec2_security_group_name }}"
    description: "{{ ec2_security_group_desc }}"
    region: "{{ ec2_region }}"
    ec2_access_key: "{{ ec2_access_key }}"
    ec2_secret_key: "{{ ec2_secret_key }}"
    rules:
      - proto: tcp
        ports:
          - 80
          - 8080
          - 22
        cidr_ip: 0.0.0.0/0
    tags:
      Name: "devops-security-group"
  register: sg_devops

- name: Set Security Group Id for DevOps
  set_fact:
    sg_devops_id: "{{ sg_devops.group_id }}"

- name: Create AWS security group for Kubernetes
  ec2_group:
    name: "kubernetes"
    description: "AWS Kubernetes SG"
    region: "{{ ec2_region }}"
    ec2_access_key: "{{ ec2_access_key }}"
    ec2_secret_key: "{{ ec2_secret_key }}"
    vpc_id: "{{ vpc_id }}"
    rules:
      - proto: -1
        from_port: 0
        to_port: 65535
        cidr_ip: "{{ aws_vpc_cidr_block }}"
        group_name: allow-all-ingress
        group_desc: "Allow all ingress"
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: 0.0.0.0/0
        group_name: allow-ssh-connection
        group_desc: "Allow SSH Connection"
    rules_egress:
      - proto: -1
        from_port: 0
        to_port: 65535
        cidr_ip: 0.0.0.0/0
        group_name: allow-all-egress
        group_desc: "Allow all Egress"
    tags:
      Name: "kubernetes-securitygroup-{{ aws_cluster_name }}"
  register: kubernetes_sg

- name: Set Security Group Id for Kubernetes
  set_fact:
    sg_kubernetes_id: "{{ kubernetes_sg.group_id }}"

- name: Create AWS security group for ELB
  ec2_group:
    name: "{{ aws_lb_security_group_name }}"
    description: "AWS ELB SG"
    region: "{{ ec2_region }}"
    ec2_access_key: "{{ ec2_access_key }}"
    ec2_secret_key: "{{ ec2_secret_key }}"
    vpc_id: "{{ vpc_id }}"
    rules:
      - proto: tcp
        from_port: 6443
        to_port: 6443
        cidr_ip: 0.0.0.0/0
        group_name: aws-allow-api-access
        group_desc: "Allow API Access"
    rules_egress:
      - proto: tcp
        from_port: 0
        to_port: 65535
        cidr_ip: 0.0.0.0/0
        group_name: aws-allow-api-egress
        group_desc: "Allow API Egress"
    tags:
      Name: "kubernetes-securitygroup-elb-{{ aws_cluster_name }}"
  register: elb_sg

- name: Set Security Group Id for ELB
  set_fact:
    sg_elb_id: "{{ elb_sg.group_id }}"